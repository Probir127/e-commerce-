{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}
{{ block.super }}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
    body {
        font-family: 'Inter', sans-serif;
        background-color: #f3f4f6;
    }

    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding: 0 5px;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 20px;
    }

    .db-title {
        font-size: 24px;
        font-weight: 700;
        color: #111827;
    }

    .filter-group {
        display: inline-flex;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        overflow: hidden;
    }

    .filter-btn {
        padding: 8px 16px;
        font-size: 13px;
        font-weight: 500;
        color: #6b7280;
        border: none;
        background: white;
        border-right: 1px solid #d1d5db;
        text-decoration: none;
        cursor: pointer;
        transition: all 0.2s;
    }

    .filter-btn:last-child {
        border-right: none;
    }

    .filter-btn:hover {
        background: #f9fafb;
        color: #374151;
    }

    .filter-btn.active {
        background: #eef2ff;
        color: #4f46e5;
        font-weight: 600;
    }

    .btn-add {
        background: #4f46e5;
        color: #ffffff !important;
        padding: 10px 20px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.2s;
        box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2);
    }

    .btn-add:hover {
        background: #4338ca;
        transform: translateY(-1px);
    }

    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }

    .main-content-grid {
        display: grid;
        grid-template-columns: 2fr 3fr;
        /* Table 40%, Chart 60% */
        gap: 20px;
        align-items: start;
    }

    @media (max-width: 1200px) {
        .dashboard-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        @media (max-width: 992px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .main-content-grid {
                grid-template-columns: 1fr;
            }
        }

        .main-content-grid {
            grid-template-columns: 1fr;
        }
    }

    .kpi-card {
        background: white;
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        border: 1px solid #e5e7eb;
        transition: transform 0.2s;
    }

    .kpi-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .kpi-label {
        font-size: 13px;
        font-weight: 600;
        text-transform: uppercase;
        color: #6b7280;
        margin-bottom: 5px;
        letter-spacing: 0.05em;
    }

    .kpi-value {
        font-size: 30px;
        font-weight: 700;
        color: #1f2937;
    }

    .kpi-value.positive {
        color: #059669;
    }

    .kpi-value.negative {
        color: #dc2626;
    }

    .chart-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        border: 1px solid #e5e7eb;
        margin-bottom: 30px;
        overflow: hidden;
        /* To clip header corners */
    }

    .table-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        border: 1px solid #e5e7eb;
        overflow: hidden;
    }

    .section-header {
        padding: 20px 25px;
        border-bottom: 1px solid #e5e7eb;
        font-size: 18px;
        font-weight: 600;
        color: #111827;
        background: #f9fafb;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th {
        background: #f9fafb;
        color: #374151;
        font-weight: 600;
        text-align: left;
        padding: 15px 25px;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    td {
        padding: 16px 25px;
        border-bottom: 1px solid #f3f4f6;
        color: #4b5563;
        font-size: 14px;
    }

    tr:last-child td {
        border-bottom: none;
    }

    tr:hover td {
        background: #f9fafb;
    }

    .badge {
        padding: 4px 10px;
        border-radius: 9999px;
        font-size: 12px;
        font-weight: 600;
    }

    .badge.income {
        background: #d1fae5;
        color: #065f46;
    }

    .badge.expense {
        background: #fee2e2;
        color: #991b1b;
    }
</style>
{% endblock %}

{% block content %}
<div style="padding: 20px;">

    <div class="dashboard-header">
        <div class="header-left">
            <div class="db-title">Financial Overview</div>
            <div class="filter-group">
                <a href="?days=7" class="filter-btn {% if days_filter == '7' %}active{% endif %}">7 Days</a>
                <a href="?days=30" class="filter-btn {% if days_filter == '30' %}active{% endif %}">30 Days</a>
            </div>
        </div>
        <a href="{{ add_url }}" class="btn-add">+ Add Transaction</a>
    </div>

    <!-- KPI GRID -->
    <div class="dashboard-grid">
        <div class="kpi-card">
            <div class="kpi-label">Total Revenue</div>
            <div class="kpi-value">Tk {{ total_revenue|floatformat:2 }}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Total Expenses</div>
            <div class="kpi-value negative">Tk {{ total_expenses|floatformat:2 }}</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Net Profit</div>
            <div class="kpi-value {% if net_profit >= 0 %}positive{% else %}negative{% endif %}">
                Tk {{ net_profit|floatformat:2 }}
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Cash Flow (30 Days)</div>
            <div class="kpi-value">Tk {{ monthly_cashflow|floatformat:0 }}</div>
        </div>
    </div>

    <!-- MAIN CONTENT GRID (Table Left, Chart Right) -->
    <div class="main-content-grid">

        <!-- RECENT TRANSACTIONS TABLE -->
        <div class="table-section">
            <div class="section-header">Recent Transactions (Ledger)</div>
            <table>
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Type</th>
                        <th>Amount</th>
                        <th style="text-align: right;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in recent_entries %}
                    <tr>
                        <td>{{ entry.date|date:"M d, Y" }}</td>
                        <td>
                            <span style="font-weight: 500; color: #1f2937;">
                                {{ entry.description|truncatechars:40 }}
                            </span>
                        </td>
                        <td>
                            <span class="badge {{ entry.entry_type }}">
                                {{ entry.get_entry_type_display }}
                            </span>
                        </td>
                        <td
                            style="font-weight: 600; {% if entry.entry_type == 'income' %}color: #059669;{% else %}color: #dc2626;{% endif %}">
                            Tk {{ entry.amount }}
                        </td>
                        <td style="text-align: right;">
                            <a href="{% url 'admin:store_accountingentry_change' entry.id %}" title="Edit"
                                style="color: #4b5563; margin-right: 10px; text-decoration: none; font-size: 16px;">
                                ‚úèÔ∏è
                            </a>
                            <a href="{% url 'admin:store_accountingentry_delete' entry.id %}" title="Delete"
                                style="color: #dc2626; text-decoration: none; font-size: 16px;">
                                üóëÔ∏è
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: #9ca3af;">
                            No transactions found. Add one manually or make a sale.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- SALES CHART -->
        <div class="chart-section" style="margin-bottom: 0;">
            <div class="section-header">
                Revenue Trend (Last {{ days_filter }} Days)
            </div>
            <div style="padding: 25px;">
                <div style="height: 450px; position: relative;">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>

    </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>
<script>
    var ctx = document.getElementById('revenueChart').getContext('2d');
    var chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ daily_labels| safe }},
    datasets: [{
        label: 'Revenue',
        data: {{ daily_revenue| safe }},
        borderColor: '#4f46e5',
        backgroundColor: 'rgba(79, 70, 229, 0.05)',
        borderWidth: 2,
        pointBackgroundColor: '#fff',
        pointBorderColor: '#4f46e5',
        pointRadius: 4,
        fill: true
            }]
        },
    options: {
        responsive: true,
            maintainAspectRatio: false,
                legend: { display: false },
        scales: {
            yAxes: [{
                gridLines: { borderDash: [2, 4], color: '#e5e7eb' },
                ticks: { beginAtZero: true, fontColor: '#9ca3af' }
            }],
                xAxes: [{
                    gridLines: { display: false },
                    ticks: { fontColor: '#9ca3af' }
                }]
        }
    }
    });
</script>
{% endblock %}